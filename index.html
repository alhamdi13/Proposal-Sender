<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirim Proposal IKATP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-sent {
            background-color: #f3f4f6 !important;
            color: #9ca3af !important;
            cursor: default;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        
        <!-- Header -->
        <div class="bg-blue-900 p-6 text-white flex justify-between items-center flex-wrap gap-4">
            <div>
                <h1 class="text-2xl font-bold">Kirim Proposal IKATP</h1>
                <p class="text-blue-100 mt-2">Alat kirim pesan otomatis dengan pelacak status pengiriman.</p>
            </div>
            <button onclick="resetHistory()" class="bg-blue-800 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-lg border border-blue-700 transition">
                <i class="fas fa-trash-alt mr-2"></i> Reset Status
            </button>
        </div>

        <div class="p-6 space-y-6">
            
            <!-- Step 1: Upload -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h2 class="font-bold text-blue-900 mb-2">1. Unggah Database (CSV)</h2>
                <div class="flex gap-4 flex-wrap">
                    <input type="file" id="csvFile" accept=".csv" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-100 file:text-blue-700
                    hover:file:bg-blue-200
                    flex-1
                    "/>
                    <button onclick="loadSampleData()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-50 font-medium">
                        <i class="fas fa-eye mr-2"></i> Lihat Contoh
                    </button>
                </div>
            </div>

            <!-- Step 2: Draft Message -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Email Draft -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center"><i class="fas fa-envelope mr-2"></i> Draf Email</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Subjek Proposal</label>
                            <input type="text" id="emailSubject" value="Penawaran Kerjasama & Sponsorship - MUBES IKATP 2026" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 text-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Isi Email</label>
                            <textarea id="emailBody" rows="12" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 text-sm focus:border-blue-500 focus:ring-blue-500">Halo [Nama],

Ikatan Alumni Teknik Pertambangan Universitas Negeri Padang (IKATP FT UNP) akan menyelenggarakan agenda akbar:
MUSYAWARAH BESAR, PEMILIHAN KETUA UMUM & HALAL BIHALAL 2026
"Sinergi Alumni, Kuatkan Koneksi, Bangun Organisasi"

Waktu: 15 â€“ 25 Maret 2026
Lokasi: Padang (Hybrid Event)

Kegiatan ini merupakan momentum strategis untuk memperkuat brand awareness [Perusahaan] di kalangan praktisi pertambangan. Kami mengajukan permohonan kerjasama Sponsorship (Gold, Silver, Bronze) untuk menyukseskan acara tersebut.

Berikut link proposal lengkap kami:
https://drive.google.com/file/d/1205wFDiMSl_lCT_lJepegecq_66BRH7V/view?usp=sharing                               

Besar harapan kami agar [Perusahaan] dapat menjadi bagian dari kesuksesan agenda ini. Kami siap berdiskusi lebih lanjut.

Hormat kami,
Zulfiandra Agustry
Ketua Pelaksana (WA: +62 853-5518-8353)</textarea>
                            <p class="text-xs text-gray-500 mt-1">Gunakan <b>[Nama]</b> untuk nama orang dan <b>[Perusahaan]</b> untuk nama kantor.</p>
                        </div>
                    </div>
                </div>

                <!-- WA Draft -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center"><i class="fab fa-whatsapp mr-2 text-green-600"></i> Draf WhatsApp</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Pesan Chat</label>
                            <textarea id="waBody" rows="12" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 text-sm focus:border-blue-500 focus:ring-blue-500">Halo [Nama],

Saya Zulfiandra dari Panitia MUBES IKATP FT UNP 2026.

Pada Maret 2026 nanti, kami akan mengadakan Musyawarah Besar & Halal Bihalal Alumni di Padang. Kami ingin menawarkan kesempatan kerjasama sponsorship yang strategis untuk [Perusahaan] dalam acara ini.

Proposal lengkap kegiatan dapat dilihat di sini:
https://drive.google.com/file/d/1205wFDiMSl_lCT_lJepegecq_66BRH7V/view?usp=sharing

Mohon dipelajari, dan jika ada pertanyaan atau ingin diskusi paket sponsor, saya siap membantu.

Terima kasih.</textarea>
                            <p class="text-xs text-gray-500 mt-1">*Link sudah otomatis disertakan.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: List & Action -->
            <div>
                <h2 class="font-bold text-gray-900 mb-4 text-lg flex justify-between items-center">
                    <span>Daftar Penerima</span>
                    <span id="progressCount" class="text-sm font-normal text-gray-500"></span>
                </h2>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama & Perusahaan</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kontak</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="contactTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">Silakan unggah file CSV atau klik "Lihat Contoh".</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        let globalData = [];

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    globalData = results.data;
                    renderTable(globalData);
                }
            });
        });

        function loadSampleData() {
            const sampleData = [
                {
                    '1. NAMA ALUMNI': 'Randa Nofriyaldi Putma',
                    'Email address': 'contoh@email.com',
                    '11. No telp WA Pribadi': '081234567890',
                    '7 Nama Perusahaan tempat anda Bekerja saat ini': 'PT Semen Padang',
                    '2. Angkatan / Tahun Masuk': '2018'
                },
                {
                    '1. NAMA ALUMNI': 'Muhammad Ilham Cahyadi',
                    'Email address': 'ilham@contoh.com',
                    '11. No telp WA Pribadi': '081298765432',
                    '7 Nama Perusahaan tempat anda Bekerja saat ini': 'Riung Mitra Lestari',
                    '2. Angkatan / Tahun Masuk': '2014'
                }
            ];
            globalData = sampleData;
            renderTable(globalData);
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            let cleaned = phone.toString().replace(/\D/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = '62' + cleaned.substring(1);
            }
            return cleaned;
        }

        function escapeStr(str) {
            if (!str) return '';
            return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function getStorageKey(type, id) {
            return `ikatp_sent_${type}_${id}`;
        }

        function resetHistory() {
            if(confirm("Hapus semua status 'Terkirim'?")) {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('ikatp_sent_')) {
                        localStorage.removeItem(key);
                    }
                });
                if(globalData.length > 0) renderTable(globalData);
                alert("Riwayat dihapus.");
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('contactTable');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Data tidak ditemukan</td></tr>';
                return;
            }

            let sentCount = 0;

            data.forEach((row, index) => {
                const nama = row['1. NAMA ALUMNI'] || row['Nama'] || 'Alumni';
                const email = row['Email address'] || row['Email'] || '';
                
                let phoneKey = Object.keys(row).find(key => key.toLowerCase().includes('wa') || key.toLowerCase().includes('telp'));
                const phone = row[phoneKey] || '';
                
                let companyKey = Object.keys(row).find(key => key.toLowerCase().includes('perusahaan'));
                let companyRaw = row[companyKey];
                let companyDisplay = companyRaw || '-';
                let companyForMsg = companyRaw || 'Perusahaan Bapak/Ibu';

                const formattedPhone = formatPhoneNumber(phone);

                // Check Local Storage Status
                const isEmailSent = localStorage.getItem(getStorageKey('email', email)) === 'true';
                const isWaSent = localStorage.getItem(getStorageKey('wa', formattedPhone)) === 'true';

                if (isEmailSent || isWaSent) sentCount++;

                // Define Button Styles based on Status
                const emailBtnClass = isEmailSent 
                    ? "btn-sent px-3 py-1 rounded inline-flex items-center text-sm border border-gray-200" 
                    : "bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded inline-flex items-center text-sm transition cursor-pointer";
                
                const waBtnClass = isWaSent 
                    ? "btn-sent px-3 py-1 rounded inline-flex items-center text-sm border border-gray-200" 
                    : "bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1 rounded inline-flex items-center text-sm transition cursor-pointer";

                const emailBtnContent = isEmailSent ? '<i class="fas fa-check mr-1"></i> Terkirim' : '<i class="fas fa-paper-plane mr-1"></i> Email';
                const waBtnContent = isWaSent ? '<i class="fas fa-check mr-1"></i> Terkirim' : '<i class="fab fa-whatsapp mr-1"></i> WA';

                const tr = document.createElement('tr');
                tr.className = (isEmailSent && isWaSent) ? "bg-gray-50" : "hover:bg-gray-50";
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${nama}</div>
                        <div class="text-xs font-semibold text-blue-600">${companyDisplay}</div>
                        <div class="text-xs text-gray-500">${row['2. Angkatan / Tahun Masuk'] || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${email}</div>
                        <div class="text-sm text-gray-500">${phone}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="sendEmail(this, '${escapeStr(email)}', '${escapeStr(nama)}', '${escapeStr(companyForMsg)}')" class="${emailBtnClass}">
                            ${emailBtnContent}
                        </button>
                        <button onclick="sendWA(this, '${formattedPhone}', '${escapeStr(nama)}', '${escapeStr(companyForMsg)}')" class="${waBtnClass}">
                            ${waBtnContent}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Update stats
            if(data.length > 0) {
                 document.getElementById('progressCount').innerText = `${sentCount} terkirim`;
            }
        }

        function markAsSent(btn) {
            btn.className = "btn-sent px-3 py-1 rounded inline-flex items-center text-sm border border-gray-200 transition";
            btn.innerHTML = `<i class="fas fa-check mr-1"></i> Terkirim`;
        }

        function sendEmail(btn, email, name, company) {
            // Prevent clicking if already sent
            if (btn.classList.contains('btn-sent')) return;

            if (!email) {
                alert('Email tidak tersedia untuk ' + name);
                return;
            }
            
            markAsSent(btn);
            localStorage.setItem(getStorageKey('email', email), 'true');
            // Update stats
            renderTable(globalData); 

            const subject = document.getElementById('emailSubject').value;
            let body = document.getElementById('emailBody').value;
            body = body.replace(/\[Nama\]/g, name);
            body = body.replace(/\[Perusahaan\]/g, company);

            const link = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = link;
        }

        function sendWA(btn, phone, name, company) {
            // Prevent clicking if already sent
            if (btn.classList.contains('btn-sent')) return;

            if (!phone) {
                alert('Nomor WA tidak tersedia untuk ' + name);
                return;
            }

            markAsSent(btn);
            localStorage.setItem(getStorageKey('wa', phone), 'true');
            // Update stats
            renderTable(globalData);

            let message = document.getElementById('waBody').value;
            message = message.replace(/\[Nama\]/g, name);
            message = message.replace(/\[Perusahaan\]/g, company);

            const link = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(link, '_blank');
        }
    </script>
</body>
</html>
