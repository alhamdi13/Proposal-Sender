<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IKATP Mobile Blaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .btn-sent {
            background-color: #f3f4f6 !important;
            color: #9ca3af !important;
            cursor: default;
            border-color: #e5e7eb !important;
        }
        /* Hide Scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Tab Active State */
        .tab-active {
            color: #15803d; /* green-700 */
            border-bottom: 2px solid #15803d;
            font-weight: 600;
        }
        .tab-inactive {
            color: #6b7280; /* gray-500 */
            border-bottom: 2px solid transparent;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- 1. Header Compact -->
    <div class="bg-white border-b border-gray-200 px-4 py-3 flex justify-between items-center shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-green-700 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm shadow-sm">
                <i class="fas fa-paper-plane"></i>
            </div>
            <div>
                <h1 class="text-base font-bold text-gray-800 leading-none">IKATP Blaster</h1>
                <p class="text-[10px] text-gray-500 mt-0.5">Mobile Optimized</p>
            </div>
        </div>
        <button onclick="loadDataFromSheet()" class="bg-gray-50 active:bg-gray-200 text-gray-600 text-xs font-medium px-3 py-2 rounded-lg border border-gray-200 transition flex items-center gap-1.5 shadow-sm">
            <i class="fas fa-sync-alt" id="icon-refresh"></i> <span class="hidden sm:inline" id="text-refresh">Refresh</span>
        </button>
    </div>

    <!-- 2. Navigation Tabs (Menu Bawah Pindah ke Atas agar jempol fokus di list bawah) -->
    <div class="bg-white border-b border-gray-200 flex text-sm font-medium shrink-0">
        <button onclick="switchTab('list')" id="tab-list" class="flex-1 py-3 text-center tab-active transition-colors">
            <i class="fas fa-list-ul mr-1.5"></i> Daftar & Aksi
        </button>
        <button onclick="switchTab('template')" id="tab-template" class="flex-1 py-3 text-center tab-inactive transition-colors">
            <i class="fas fa-edit mr-1.5"></i> Edit Pesan
        </button>
    </div>

    <!-- 3. Main Content Area -->
    <div class="flex-1 overflow-hidden relative w-full max-w-lg mx-auto md:max-w-4xl">
        
        <!-- VIEW 1: LIST & DASHBOARD -->
        <div id="view-list" class="h-full flex flex-col absolute inset-0 bg-gray-50 transition-opacity duration-300">
            
            <!-- Dashboard Grid (Scrollable if needed, but fitted 2x2) -->
            <div class="p-3 grid grid-cols-2 gap-2 shrink-0">
                <!-- Total -->
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between">
                    <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Total Target</span>
                    <div class="flex items-center justify-between">
                        <span class="text-xl font-bold text-gray-800" id="stat-total">0</span>
                        <i class="fas fa-users text-gray-200 text-lg"></i>
                    </div>
                </div>
                
                <!-- Progress Bar Global -->
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center">
                    <div class="flex justify-between items-center mb-1.5">
                        <span class="text-[10px] text-gray-400 uppercase font-bold">Selesai</span>
                        <span class="text-xs font-bold text-green-600" id="stat-percent">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5">
                        <div id="global-progress" class="bg-green-600 h-1.5 rounded-full w-0 transition-all duration-700"></div>
                    </div>
                    <div class="mt-1 text-[10px] text-right text-gray-400" id="stat-remain">0 sisa</div>
                </div>

                <!-- Stats Detail Row -->
                <div class="col-span-2 grid grid-cols-2 gap-2">
                     <div class="bg-blue-50 p-2 rounded-lg border border-blue-100 flex items-center justify-between px-3">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-envelope text-blue-500 text-xs"></i>
                            <span class="text-xs font-medium text-blue-700">Email</span>
                        </div>
                        <span class="text-sm font-bold text-blue-800" id="stat-email">0</span>
                     </div>
                     <div class="bg-green-50 p-2 rounded-lg border border-green-100 flex items-center justify-between px-3">
                        <div class="flex items-center gap-2">
                            <i class="fab fa-whatsapp text-green-500 text-xs"></i>
                            <span class="text-xs font-medium text-green-700">WA</span>
                        </div>
                        <span class="text-sm font-bold text-green-800" id="stat-wa">0</span>
                     </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="px-3 pb-2 shrink-0">
                <div class="relative">
                    <input type="text" id="searchInput" onkeyup="filterList()" placeholder="Cari nama alumni..." class="w-full pl-9 pr-3 py-2.5 text-sm border border-gray-300 rounded-xl focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 shadow-sm">
                    <i class="fas fa-search absolute left-3.5 top-3.5 text-gray-400 text-xs"></i>
                </div>
            </div>

            <!-- Card List Container -->
            <div class="flex-1 overflow-y-auto no-scrollbar px-3 pb-20 space-y-3" id="cardContainer">
                <!-- Loading State -->
                <div class="flex flex-col items-center justify-center h-48 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-green-600"></i>
                    <span class="text-xs font-medium">Memuat Data...</span>
                </div>
            </div>
            
             <!-- Floating Info -->
             <div class="absolute bottom-4 left-0 right-0 text-center pointer-events-none">
                <span class="bg-black/70 text-white text-[10px] px-3 py-1 rounded-full backdrop-blur-sm shadow-lg">
                    Menampilkan <span id="display-count">0</span> data
                </span>
             </div>
        </div>

        <!-- VIEW 2: TEMPLATE SETTINGS -->
        <div id="view-template" class="h-full flex flex-col absolute inset-0 bg-white translate-x-full transition-transform duration-300 overflow-y-auto pb-20">
             <div class="p-5 space-y-6 max-w-lg mx-auto w-full">
                
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center text-sm">
                        <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded flex items-center justify-center mr-2"><i class="fas fa-envelope text-xs"></i></span> 
                        Template Email
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Subjek</label>
                            <input type="text" id="emailSubject" value="Penawaran Kerjasama - MUBES IKATP 2026" class="mt-1 block w-full rounded-lg border-gray-300 border p-2.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Isi Email</label>
                            <textarea id="emailBody" rows="6" class="mt-1 block w-full rounded-lg border-gray-300 border p-2.5 text-sm focus:ring-blue-500 focus:border-blue-500">Halo [Nama],

Kami mengajukan proposal sponsorship untuk [Perusahaan].
Link: https://drive.google.com/file/d/1205wFDiMSl_lCT_lJepegecq_66BRH7V/view?usp=sharing
Surat Pengantar: https://docs.google.com/document/d/1yhLImNbtjy6BtZ81Xs8mfD_IUtII0Dds/edit?usp=sharing&ouid=106003402691509808088&rtpof=true&sd=true
                                

Salam, Panitia.</textarea>
                        </div>
                    </div>
                </div>

                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center text-sm">
                         <span class="bg-green-100 text-green-600 w-6 h-6 rounded flex items-center justify-center mr-2"><i class="fab fa-whatsapp text-xs"></i></span> 
                         Template WhatsApp
                    </h3>
                    <div>
                        <textarea id="waBody" rows="8" class="block w-full rounded-lg border-gray-300 border p-2.5 text-sm focus:ring-green-500 focus:border-green-500">Halo [Nama],

Kami dari panitia MUBES IKATP ingin menawarkan kerjasama sponsorship untuk [Perusahaan].

Proposal: https://drive.google.com/file/d/1205wFDiMSl_lCT_lJepegecq_66BRH7V/view?usp=sharing
Surat Pengantar: https://docs.google.com/document/d/1yhLImNbtjy6BtZ81Xs8mfD_IUtII0Dds/edit?usp=sharing&ouid=106003402691509808088&rtpof=true&sd=true

Terima kasih.</textarea>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2 bg-white p-2 rounded border border-green-100">
                        <i class="fas fa-magic text-yellow-500 mr-1"></i> Gunakan <b>[Nama]</b> dan <b>[Perusahaan]</b> agar otomatis berubah.
                    </p>
                </div>

                <!-- Save Info -->
                <div class="text-center text-xs text-gray-400">
                    Perubahan template disimpan otomatis sementara.
                </div>
            </div>
        </div>

    </div>

    <script>
        const FIXED_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7EVjxbdbu1t88M9ePW1Xpb1-ow7b2gZTJSY2yJPITvQ46Wsc3Eoa72qE2gf3Myob26A/exec";
        let globalData = [];

        // --- UI Functions ---
        function switchTab(tab) {
            const viewList = document.getElementById('view-list');
            const viewTemplate = document.getElementById('view-template');
            const tabList = document.getElementById('tab-list');
            const tabTemplate = document.getElementById('tab-template');

            if (tab === 'list') {
                viewList.classList.remove('-translate-x-full'); // Bring back list
                viewTemplate.classList.add('translate-x-full'); // Push template right
                viewTemplate.classList.remove('inset-0'); // Hack to prevent overlap touch issues
                
                // Reset standard positioning after animation
                setTimeout(() => {
                     viewList.style.transform = 'translateX(0)';
                     viewTemplate.style.transform = 'translateX(100%)';
                }, 10);

                tabList.className = "flex-1 py-3 text-center tab-active transition-colors";
                tabTemplate.className = "flex-1 py-3 text-center tab-inactive transition-colors";
            } else {
                viewList.style.transform = 'translateX(-100%)';
                viewTemplate.style.transform = 'translateX(0)';
                viewTemplate.classList.add('inset-0');

                tabList.className = "flex-1 py-3 text-center tab-inactive transition-colors";
                tabTemplate.className = "flex-1 py-3 text-center tab-active transition-colors";
            }
        }

        // --- Data Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromSheet();
        });

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            let cleaned = phone.toString().replace(/\D/g, '');
            if (cleaned.startsWith('0')) cleaned = '62' + cleaned.substring(1);
            return cleaned;
        }

        async function loadDataFromSheet() {
            const btnIcon = document.getElementById('icon-refresh');
            const btnText = document.getElementById('text-refresh');
            const container = document.getElementById('cardContainer');
            
            btnIcon.classList.add('fa-spin');
            if(btnText) btnText.innerText = "...";

            try {
                const response = await fetch(`${FIXED_SCRIPT_URL}?action=getData`);
                const data = await response.json();
                globalData = data;
                
                renderCards(data);
                updateDashboard(data);
                
                if(btnText) btnText.innerText = "Refresh";
            } catch (error) {
                console.error(error);
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-48 text-red-400 p-4 text-center">
                        <i class="fas fa-wifi text-3xl mb-2"></i>
                        <span class="text-sm">Gagal memuat data.<br>Cek koneksi internet Anda.</span>
                        <button onclick="loadDataFromSheet()" class="mt-4 bg-white border border-red-200 text-red-500 px-4 py-2 rounded-lg text-xs shadow-sm">Coba Lagi</button>
                    </div>`;
            } finally {
                btnIcon.classList.remove('fa-spin');
            }
        }

        function updateDashboard(data) {
            const total = data.length;
            if (total === 0) return;

            let emailCount = 0;
            let waCount = 0;

            data.forEach(row => {
                const sEmail = row['Status Email'] || '';
                const sWA = row['Status WA'] || '';
                if (sEmail.toLowerCase().includes('terkirim')) emailCount++;
                if (sWA.toLowerCase().includes('terkirim')) waCount++;
            });

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-email').innerText = emailCount;
            document.getElementById('stat-wa').innerText = waCount;
            document.getElementById('display-count').innerText = total;

            const totalActions = total * 2;
            const doneActions = emailCount + waCount;
            const globalPercent = Math.round((doneActions / totalActions) * 100);

            document.getElementById('global-progress').style.width = `${globalPercent}%`;
            document.getElementById('stat-percent').innerText = `${globalPercent}%`;
            document.getElementById('stat-remain').innerText = `${totalActions - doneActions} aksi`;
        }

        function filterList() {
            const input = document.getElementById("searchInput").value.toLowerCase();
            const filtered = globalData.filter(row => {
                const name = (row['Nama'] || '').toLowerCase();
                const company = (row['Perusahaan'] || '').toLowerCase();
                return name.includes(input) || company.includes(input);
            });
            renderCards(filtered);
            document.getElementById('display-count').innerText = filtered.length;
        }

        function renderCards(data) {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-gray-400 text-sm">Data tidak ditemukan.</div>';
                return;
            }

            data.forEach((row) => {
                const nama = row['Nama'] || 'Tanpa Nama';
                const email = row['Email'] || '';
                const wa = row['No WA'] || '';
                const perusahaan = row['Perusahaan'] || '-';
                const statusEmail = row['Status Email'] || '';
                const statusWA = row['Status WA'] || '';
                
                const formattedWA = formatPhoneNumber(wa);
                const isEmailDone = statusEmail && statusEmail.toLowerCase().includes('terkirim');
                const isWaDone = statusWA && statusWA.toLowerCase().includes('terkirim');
                const isFullyDone = isEmailDone && isWaDone;

                // Card Element
                const card = document.createElement('div');
                card.className = isFullyDone 
                    ? "bg-gray-50 rounded-xl border border-gray-200 p-4 opacity-75 grayscale-[30%]" 
                    : "bg-white rounded-xl border border-gray-200 shadow-sm p-4";

                card.innerHTML = `
                    <!-- Header: Name & Company -->
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm leading-tight">${nama}</h3>
                            <div class="text-xs text-gray-500 mt-1 flex items-center">
                                <i class="fas fa-building text-[10px] mr-1.5 opacity-60"></i> ${perusahaan}
                            </div>
                        </div>
                        ${isFullyDone ? '<span class="text-green-500 text-xs"><i class="fas fa-check-circle text-lg"></i></span>' : ''}
                    </div>

                    <!-- Actions Grid -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Email Action -->
                        <div class="flex flex-col gap-2">
                             <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">Email</span>
                                ${isEmailDone 
                                    ? '<span class="text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded border border-green-100">Terkirim</span>' 
                                    : '<span class="text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100">Belum</span>'}
                             </div>
                             <button onclick="sendAction(this, 'email', '${email}', '${nama.replace(/'/g, "\\'")}', '${perusahaan}')"
                                     class="w-full py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition active:scale-95 ${isEmailDone ? 'btn-sent border text-gray-400' : 'bg-blue-50 text-blue-700 border border-blue-200 active:bg-blue-100'}">
                                 ${isEmailDone ? '<i class="fas fa-check"></i> Selesai' : '<i class="fas fa-paper-plane"></i> Kirim'}
                             </button>
                        </div>

                        <!-- WA Action -->
                        <div class="flex flex-col gap-2">
                             <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">WhatsApp</span>
                                ${isWaDone 
                                    ? '<span class="text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded border border-green-100">Terkirim</span>' 
                                    : '<span class="text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100">Belum</span>'}
                             </div>
                             <button onclick="sendAction(this, 'wa', '${formattedWA}', '${nama.replace(/'/g, "\\'")}', '${perusahaan}')"
                                     class="w-full py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition active:scale-95 ${isWaDone ? 'btn-sent border text-gray-400' : 'bg-green-50 text-green-700 border border-green-200 active:bg-green-100'}">
                                 ${isWaDone ? '<i class="fas fa-check"></i> Selesai' : '<i class="fab fa-whatsapp text-sm"></i> Kirim'}
                             </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function sendAction(btn, type, contact, name, company) {
            if (btn.classList.contains('btn-sent')) return;
            if (!contact) { alert('Kontak kosong/tidak valid!'); return; }

            // 1. Open App
            if (type === 'email') {
                const subject = document.getElementById('emailSubject').value;
                let body = document.getElementById('emailBody').value;
                body = body.replace(/\[Nama\]/g, name).replace(/\[Perusahaan\]/g, company);
                window.location.href = `mailto:${contact}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            } else {
                let message = document.getElementById('waBody').value;
                message = message.replace(/\[Nama\]/g, name).replace(/\[Perusahaan\]/g, company);
                window.open(`https://wa.me/${contact}?text=${encodeURIComponent(message)}`, '_blank');
            }

            // 2. UI Loading
            const originalInner = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.classList.add('opacity-50', 'pointer-events-none');

            // 3. Backend Update
            try {
                const payload = JSON.stringify({ identifier: contact, type: type });
                // Fire and forget style for smoother UX on mobile
                fetch(`${FIXED_SCRIPT_URL}?action=updateStatus`, {
                    method: 'POST',
                    body: payload,
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' }
                });

                // Optimistic UI Update immediately
                btn.className = "w-full py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 btn-sent border text-gray-400";
                btn.innerHTML = '<i class="fas fa-check"></i> Selesai';
                
                // Update local stats
                updateLocalStats(type);

            } catch (err) {
                console.error(err);
                btn.innerHTML = originalInner;
                btn.classList.remove('opacity-50', 'pointer-events-none');
                alert("Gagal menyimpan status, tapi aplikasi WA/Email sudah terbuka.");
            }
        }

        function updateLocalStats(type) {
            // Simple visual increment
            if(type === 'email') {
                const el = document.getElementById('stat-email');
                el.innerText = parseInt(el.innerText) + 1;
            } else {
                const el = document.getElementById('stat-wa');
                el.innerText = parseInt(el.innerText) + 1;
            }
            // Update global prog bar slightly
            const currentPercent = parseInt(document.getElementById('stat-percent').innerText);
            if(currentPercent < 100) {
                 // rough estimation just for visual feedback
                 document.getElementById('global-progress').style.width = `${currentPercent + 1}%`;
            }
        }
    </script>
</body>
</html>
